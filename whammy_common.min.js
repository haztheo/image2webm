function doubleToString(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")}function checkFrames(a){for(var t=a[0].width,r=a[0].height,e=a[0].duration,i=1;i<a.length;i++){if(a[i].width!=t)throw"Frame "+(i+1)+" has a different width";if(a[i].height!=r)throw"Frame "+(i+1)+" has a different height";if(a[i].duration<0)throw"Frame "+(i+1)+" has a weird duration";e+=a[i].duration}return{duration:e,width:t,height:r}}function numToBuffer(a){for(var t=[];a>0;)t.push(255&a),a>>=8;return new Uint8Array(t.reverse())}function toBinStr_old(a){var t="",r=a.length%8?new Array(9-a.length%8).join("0"):"";a=r+a;for(var e=0;e<a.length;e+=8)t+=String.fromCharCode(parseInt(a.substr(e,8),2));return t}function makeSimpleBlock(a){var t=0;if(a.keyframe&&(t|=128),a.invisible&&(t|=8),a.lacing&&(t|=a.lacing<<1),a.discardable&&(t|=1),a.trackNum>127)throw"TrackNumber > 127 not supported";var r=[128|a.trackNum,a.timecode>>8,255&a.timecode,t].map(function(a){return String.fromCharCode(a)}).join("")+a.frame;return r}function parseWebP(a){for(var t=a.RIFF[0].WEBP[0],r=t.indexOf("*"),e=0,i=[];4>e;e++)i[e]=t.charCodeAt(r+3+e);var n,o,d,s,h;return h=i[1]<<8|i[0],n=16383&h,o=h>>14,h=i[3]<<8|i[2],d=16383&h,s=h>>14,{width:n,height:d,data:t,riff:a}}function WhammyVideo(a,t){this.frames=[],this.duration=1e3/a,this.quality=t||.8}function strToBuffer(a){for(var t=new Uint8Array(a.length),r=0;r<a.length;r++)t[r]=a.charCodeAt(r);return t}function bitsToBuffer(a){var t=[],r=a.length%8?new Array(9-a.length%8).join("0"):"";a=r+a;for(var e=0;e<a.length;e+=8)t.push(parseInt(a.substr(e,8),2));return new Uint8Array(t)}function parseRIFF(a){for(var t=0,r={};t<a.length;){var e=a.substr(t,4);if(r[e]=r[e]||[],"RIFF"==e||"LIST"==e){var i=parseInt(a.substr(t+4,4).split("").map(function(a){var t=a.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t}).join(""),2),n=a.substr(t+4+4,i);t+=8+i,r[e].push(parseRIFF(n))}else"WEBP"==e?(r[e].push(a.substr(t+8)),t=a.length):(r[e].push(a.substr(t+4)),t=a.length)}return r}function generateEBML(a,t){for(var r=[],e=0;e<a.length;e++)if("id"in a[e]){var i=a[e].data;if("object"==typeof i&&(i=generateEBML(i,t)),"number"==typeof i&&(i="size"in a[e]?numToFixedBuffer(i,a[e].size):bitsToBuffer(i.toString(2))),"string"==typeof i&&(i=strToBuffer(i)),i.length);var o=i.size||i.byteLength||i.length,d=Math.ceil(Math.ceil(Math.log(o)/Math.log(2))/8),s=o.toString(2),h=new Array(7*d+7+1-s.length).join("0")+s,f=new Array(d).join("0")+"1"+h;r.push(numToBuffer(a[e].id)),r.push(bitsToBuffer(f)),r.push(i)}else r.push(a[e]);if(t){var c=toFlatArray(r);return new Uint8Array(c)}return new Blob(r,{type:"video/webm"})}function numToFixedBuffer(a,t){for(var r=new Uint8Array(t),e=t-1;e>=0;e--)r[e]=255&a,a>>=8;return r}function toFlatArray(a,t){null==t&&(t=[]);for(var r=0;r<a.length;r++)"object"==typeof a[r]?toFlatArray(a[r],t):t.push(a[r]);return t}function toWebM(a,t){for(var r=checkFrames(a),e=3e4,i=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:doubleToString(r.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:r.width,id:176},{data:r.height,id:186}]}]}]},{id:475249515,data:[]}]}],n=i[1],o=n.data[2],d=0,s=0;d<a.length;){var h={id:187,data:[{data:Math.round(s),id:179},{id:183,data:[{data:1,id:247},{data:0,size:8,id:241}]}]};o.data.push(h);var f=[],c=0;do f.push(a[d]),c+=a[d].duration,d++;while(d<a.length&&e>c);var u=0,l={id:524531317,data:[{data:Math.round(s),id:231}].concat(f.map(function(a){var t=makeSimpleBlock({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(u)});return u+=a.duration,{data:t,id:163}}))};n.data.push(l),s+=c}for(var v=0,b=0;b<n.data.length;b++){b>=3&&(o.data[b-3].data[1].data[1].data=v);var m=generateEBML([n.data[b]],t);v+=m.size||m.byteLength||m.length,2!=b&&(n.data[b]=m)}return generateEBML(i,t)}WhammyVideo.prototype.add=function(a,t){if("undefined"!=typeof t&&this.duration)throw"you can't pass a duration if the fps is set";if("canvas"in a&&(a=a.canvas),"toDataURL"in a)a=a.toDataURL("image/webp",this.quality);else if("string"!=typeof a)throw"frame must be a a HTMLCanvasElement, a CanvasRenderingContext2D or a DataURI formatted string";if(!/^data:image\/webp;base64,/gi.test(a))throw"Input must be formatted properly as a base64 encoded DataURI of type image/webp";this.frames.push({image:a,duration:t||this.duration})},WhammyVideo.prototype.encodeFrames=function(a){if(this.frames[0].image instanceof ImageData){var t=this.frames,r=document.createElement("canvas"),e=r.getContext("2d");r.width=this.frames[0].image.width,r.height=this.frames[0].image.height;var i=function(n){console.log("encodeFrame",n);var o=t[n];e.putImageData(o.image,0,0),o.image=r.toDataURL("image/webp",this.quality),n<t.length-1?setTimeout(function(){i(n+1)},1):a()}.bind(this);i(0)}else a()},WhammyVideo.prototype.compile=function(a,t){this.encodeFrames(function(){var r=new toWebM(this.frames.map(function(a){var t=parseWebP(parseRIFF(atob(a.image.slice(23))));return t.duration=a.duration,t}),a);t(r)}.bind(this))},window.Whammy=function(){return{Video:WhammyVideo,fromImageArray:function(a,t,r){return toWebM(a.map(function(a){var r=parseWebP(parseRIFF(atob(a.slice(23))));return r.duration=1e3/t,r}),r)},toWebM:toWebM}}();