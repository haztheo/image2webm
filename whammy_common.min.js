function doubleToString(a){return[].slice.call(new Uint8Array(new Float64Array([a]).buffer),0).map(function(a){return String.fromCharCode(a)}).reverse().join("")}function checkFrames(a){for(var t=a[0].width,e=a[0].height,r=a[0].duration,i=1;i<a.length;i++){if(a[i].width!==t)throw Error("Frame "+(i+1)+" has a different width");if(a[i].height!==e)throw Error("Frame "+(i+1)+" has a different height");if(a[i].duration<0)throw Error("Frame "+(i+1)+" has a weird duration");r+=a[i].duration}return{duration:r,width:t,height:e}}function numToBuffer(a){for(var t=[];a>0;)t.push(255&a),a>>=8;return new Uint8Array(t.reverse())}function makeSimpleBlock(a){var t=0;if(a.keyframe&&(t|=128),a.invisible&&(t|=8),a.lacing&&(t|=a.lacing<<1),a.discardable&&(t|=1),a.trackNum>127)throw Error("TrackNumber > 127 not supported");return[128|a.trackNum,a.timecode>>8,255&a.timecode,t].map(function(a){return String.fromCharCode(a)}).join("")+a.frame}function parseWebP(a){for(var t=a.RIFF[0].WEBP[0],e=t.indexOf("¬ù*"),r=0,i=[];r<4;r++)i[r]=t.charCodeAt(e+3+r);var n,o,d;return d=i[1]<<8|i[0],n=16383&d,d=i[3]<<8|i[2],o=16383&d,{width:n,height:o,data:t,riff:a}}function WhammyVideo(a,t){this.frames=[],this.duration=1e3/a,this.quality=t||.8}function strToBuffer(a){for(var t=new Uint8Array(a.length),e=0;e<a.length;e++)t[e]=a.charCodeAt(e);return t}function bitsToBuffer(a){var t=[];a=(a.length%8?new Array(9-a.length%8).join("0"):"")+a;for(var e=0;e<a.length;e+=8)t.push(parseInt(a.substr(e,8),2));return new Uint8Array(t)}function parseRIFF(a){for(var t=0,e={};t<a.length;){var r=a.substr(t,4);if(e[r]=e[r]||[],"RIFF"===r||"LIST"===r){var i=parseInt(a.substr(t+4,4).split("").map(function(a){var t=a.charCodeAt(0).toString(2);return new Array(8-t.length+1).join("0")+t}).join(""),2),n=a.substr(t+4+4,i);t+=8+i,e[r].push(parseRIFF(n))}else"WEBP"===r?(e[r].push(a.substr(t+8)),t=a.length):(e[r].push(a.substr(t+4)),t=a.length)}return e}function generateEBML(a,t){for(var e=[],r=0;r<a.length;r++)if("id"in a[r]){var i=a[r].data;if("object"==typeof i&&(i=generateEBML(i,t)),"number"==typeof i&&(i="size"in a[r]?numToFixedBuffer(i,a[r].size):bitsToBuffer(i.toString(2))),"string"==typeof i&&(i=strToBuffer(i)),i.length);var n=i.size||i.byteLength||i.length,o=Math.ceil(Math.ceil(Math.log(n)/Math.log(2))/8),d=n.toString(2),u=new Array(7*o+7+1-d.length).join("0")+d,s=new Array(o).join("0")+"1"+u;e.push(numToBuffer(a[r].id)),e.push(bitsToBuffer(s)),e.push(i)}else e.push(a[r]);if(t){var h=toFlatArray(e);return new Uint8Array(h)}return new Blob(e,{type:"video/webm"})}function numToFixedBuffer(a,t){for(var e=new Uint8Array(t),r=t-1;r>=0;r--)e[r]=255&a,a>>=8;return e}function toFlatArray(a,t){null==t&&(t=[]);for(var e=0;e<a.length;e++)"object"==typeof a[e]?toFlatArray(a[e],t):t.push(a[e]);return t}function toWebM(a,t){for(var e=checkFrames(a),r=[{id:440786851,data:[{data:1,id:17030},{data:1,id:17143},{data:4,id:17138},{data:8,id:17139},{data:"webm",id:17026},{data:2,id:17031},{data:2,id:17029}]},{id:408125543,data:[{id:357149030,data:[{data:1e6,id:2807729},{data:"whammy",id:19840},{data:"whammy",id:22337},{data:doubleToString(e.duration),id:17545}]},{id:374648427,data:[{id:174,data:[{data:1,id:215},{data:1,id:29637},{data:0,id:156},{data:"und",id:2274716},{data:"V_VP8",id:134},{data:"VP8",id:2459272},{data:1,id:131},{id:224,data:[{data:e.width,id:176},{data:e.height,id:186}]}]}]},{id:475249515,data:[]}]}],i=r[1],n=i.data[2],o=0,d=0;o<a.length;){var u={id:187,data:[{data:Math.round(d),id:179},{id:183,data:[{data:1,id:247},{data:0,size:8,id:241}]}]};n.data.push(u);var s=[],h=0;do{s.push(a[o]),h+=a[o].duration,o++}while(o<a.length&&h<3e4);var f=0,m={id:524531317,data:[{data:Math.round(d),id:231}].concat(s.map(function(a){var t=makeSimpleBlock({discardable:0,frame:a.data.slice(4),invisible:0,keyframe:1,lacing:0,trackNum:1,timecode:Math.round(f)});return f+=a.duration,{data:t,id:163}}))};i.data.push(m),d+=h}for(var c=0,g=0;g<i.data.length;g++){g>=3&&(n.data[g-3].data[1].data[1].data=c);var l=generateEBML([i.data[g]],t);c+=l.size||l.byteLength||l.length,2!==g&&(i.data[g]=l)}return generateEBML(r,t)}WhammyVideo.prototype.add=function(a,t){if(void 0!==t&&this.duration)throw Error("you can't pass a duration if the fps is set");if("canvas"in a&&(a=a.canvas),"toDataURL"in a)a=a.toDataURL("image/webp",this.quality);else if("string"!=typeof a)throw Error("frame must be a a HTMLCanvasElement, a CanvasRenderingContext2D or a DataURI formatted string");if(!/^data:image\/webp;base64,/gi.test(a))throw Error("Input must be formatted properly as a base64 encoded DataURI of type image/webp");this.frames.push({image:a,duration:t||this.duration})},WhammyVideo.prototype.encodeFrames=function(a){if(this.frames[0].image instanceof ImageData){var t=this.frames,e=document.createElement("canvas"),r=e.getContext("2d");e.width=this.frames[0].image.width,e.height=this.frames[0].image.height;var i=function(n){var o=t[n];r.putImageData(o.image,0,0),o.image=e.toDataURL("image/webp",this.quality),n<t.length-1?setTimeout(function(){i(n+1)},1):a()}.bind(this);i(0)}else a()},WhammyVideo.prototype.compile=function(a,t){this.encodeFrames(function(){var e=new toWebM(this.frames.map(function(a){var t=parseWebP(parseRIFF(atob(a.image.slice(23))));return t.duration=a.duration,t}),a);t(e)}.bind(this))},module.exports={Video:WhammyVideo,fromImageArray:function(a,t,e){return toWebM(a.map(function(a){var e=parseWebP(parseRIFF(atob(a.slice(23))));return e.duration=1e3/t,e}),e)},toWebM:toWebM};